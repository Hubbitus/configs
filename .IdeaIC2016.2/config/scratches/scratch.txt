[From: Bianco Prieto-Ilarion]
 Привет

[From: Bianco Prieto-Ilarion]
Паша, напиши как будешь на связи, есть вопросы по ролевой модели: http://git.taskdata.com/glr/glr-portal/issues/21

...

[From: Bianco Prieto-Ilarion]
 Честно говоря, эту фразу не понял: "Предлагается ресурс ограничений (уровни доступа), тот что не на уровне базовых прав, сделать стандартным, например куском условия WHERE запроса. Тогда их можно будет подставить автоматически в момент формирования запросов в маппинге MyBatis."

[From: Bianco Prieto-Ilarion]
 ауау

[From: Pavel Alexeev]
ну надо нам сделать так, чтобы не хардкодить много уровней и идентификаторов со ссылками на разные типы объектов и полей. Лучше наиболее общим способом. Более того, SSO отменён в этом году, но их надо будет взять из ЕГАИС так или иначе.

[From: Bianco Prieto-Ilarion]
 ничего не понял. Смотри, у нас есть REST API

[From: Bianco Prieto-Ilarion]
 И есть пользователи. Я делаю REST API. Какие варианты тут разграничения прав получаются?
[From: Bianco Prieto-Ilarion]
 - Чисто по ролям?
- Роли по пермиссиям (то есть более гранулярные)
- Роли + пермиссии
- Или же и доступ к конкретному объекту тоже может отдельным быть?
У пользователя должны быть список ролей, из них берём наиболее разрешительные по ресурсу. Плюс должно быть ограничение на видимость данных, некий фильтр.

[From: Bianco Prieto-Ilarion]
 "Плюс должно быть ограничение на видимость данных, некий фильтр." - вот это что? Как с ролями соотносится?

[From: Pavel Alexeev]
Вот же: http://git.taskdata.com/glr/glr-portal/wikis/project-vision#%D0%A0%D0%BE%D0%BB%D0%B5%D0%B2%D0%B0%D1%8F-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81-%D1%81%D0%BE%D0%B3%D0%BB%D0%B0%D1%81%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F

[From: ilya]
 Пример:
Есть некая таблица "реестр", в зависимости от роли пользователя там будет разный набор данных

/This message was edited
 То есть пользователю указываем скажем роль, в которой есть ресурс LEVEL_REGION (уровень Себъект РФ). Его мало просто, нужен идентификатор этого региона, который буде ссылаться скажем в region.id

[From: Pavel Alexeev]
Но в случае с LEVEL_DISTRICT (уровень ФО), айдишник уже должен быть на запись из district.id.
Я предлагаю сделать как можно более общим способом. Скажем создаём ROLE_FILTER. Туда написать нечто "district.id = 17". Дальше в MyBatis запросе это учитываем для имеющегося типа и автоматически подставляем в WHERE

[From: Bianco Prieto-Ilarion]
 01/09/16 в 16:24 Павел Алексеев написал (-а):
> Но в случае с LEVEL_DISTRICT (уровень ФО), айдишник уже должен быть на запись из district.id.

ок, понял, то есть всё таки это доступ не на уровне просто ролей/персиссий, а на уровне объектов

[From: Pavel Alexeev]
MyBatis в bind выражении позволяет использовать OGNL, то есть фактически любую логику. Наверное стоит вынести в некоторый класс её, чтобы не хардкодить много в XML. Заодно можно будет успешно протестировать.

Если есть желание, в этот строковый атрибут фильтра, можно положить что-то вроде JSON скажем. Но очень хочется унифицировать и логику сосредоточить в одном месте, для расширения. Это же будет важно для интеграции в будущем. То есть не должно быть разных типов пользователей, с разными столбцами в БД. Всё должно остаться в плоских атрибутах ролевых ресурсов.

[From: Bianco Prieto-Ilarion]
 Вот есть роль Субъект

[From: Bianco Prieto-Ilarion]
 какие ты видишь роли для
- субъект
- субъект +  VIEW?
LEVEL_REGION, ROLE_FILTER = "region.id = 17"

[From: Pavel Alexeev]
Фильтр всё равно не бит, а строка.
Ну или типа: LEVEL_REGION, ROLE_FILTER = '{ "region": { "id": 17} }'

[From: Bianco Prieto-Ilarion]
 не понял

[From: Bianco Prieto-Ilarion]
 2 варианта:
- субъект 17
- субъект 17 +  SIGN?
This message was edited

[From: Bianco Prieto-Ilarion]
 какое различие в ролях?
Что здесь VIEW? Не предлагается же для каждого имеющегося субъекта или лесничества создавать отдельную вьюху в базе?

[From: Bianco Prieto-Ilarion]
 ой

[From: Bianco Prieto-Ilarion]
 не VIEW а  SIGN - из твоей доки
SIGN либо есть, либо нет, Boolean. Если он указан для пользователя с ролями "Субъект 17", то он может подписывать данные субъекта 17. Если его нет, но есть READ, он может просматривать данные субъекта 17. За даные этого субъекта он не может выйти, а эти ресурсы означают что он может делать с ними.

/This message was edited

[From: Bianco Prieto-Ilarion]
 01/09/16 в 16:39 Павел Алексеев написал (-а):
> SIGN либо есть, либо нет, Boolean. Если он указан для пользователя с ролями "Субъект 17", то он может подписывать данные субъекта 17. Если его нет, но есть READ, он может просматривать данные субъекта 17. За даные этого субъекта он не может выйти, а эти ресурсы означают что он может делать с ними.
 с точки зрения Spring Security  SIGN это что? Это GrantedAuthority?
This message was edited

[From: Pavel Alexeev]
 да, эти просто Authority. Их можно просто на методы повесить. Если нет READ, то нечего и запрос выполнять.

[From: Bianco Prieto-Ilarion]
 То есть у нас модель для SS будет такая:
таблица users
таблица roles
таблица privileges
?

В privileges что?


[From: Bianco Prieto-Ilarion]
 CREATE
READ
UPDATE
DELETE
SIGN

[From: Pavel Alexeev]
ну пусть. А куда ограничение на данные?

[From: Pavel Alexeev]
Там же просто столбец текстовый?

[From: Bianco Prieto-Ilarion]
 ну я пока не уверен что это вообще нужно делать на уровне  SQL, там я посмотрю, может в самих аннотациях на контроллерах можно будет сделать

[From: Pavel Alexeev]
сохранить-то ты где планируешь это?

[From: Pavel Alexeev]
что он к 17 субъекту принадлежит
в аннотации контроллера это не впихнёшь, это всё равно в запросы должно будет провалиться

[From: Bianco Prieto-Ilarion]
 там же SpEL - может что-то вроде @PreAuthorize("hasRole('SUBJET')" and "hasPrivelege('VIEW') and hasAccessToObject"${objectId}")

[From: Bianco Prieto-Ilarion]
 ну это псевдокод, я про общую идею

[From: Pavel Alexeev]
'and hasAccessToObject"${objectId}")' а objectId откуда? В аннотоации у тебя могут быть только static final константы. А это будет атрибутом роли (одной из) пользователя.

[From: Bianco Prieto-Ilarion]
 01/09/16 в 16:55 Павел Алексеев написал (-а):
> 'and hasAccessToObject"${objectId}")' а objectId откуда? В аннотоации у тебя могут быть только static final константы. А это будет атрибутом роли (одной из) пользователя.

Из параметров запроса, ну в общем я это посмотрю, я пока хочу понять модели для Spring Security

[From: Bianco Prieto-Ilarion]
 в общем вижу так:
таблица users
таблица roles - 4 роли
таблица privileges - 5 привелегий на действия
Плюс это можно будет ещё скажем для getById попробовать сделать. Там можно и эксепшен вывалить если запрошено то что видеть нельзя. А если список запрашивается, надо просто отдать видимый набор данных, а не выбрать всё из базы, а потом фильтровать

[From: Pavel Alexeev]
> в общем вижу так:
Так и не понимаю куда и как предлагается записать условие фильтрации видимых данных.

[From: Bianco Prieto-Ilarion]
 01/09/16 в 16:58 Павел Алексеев написал (-а):
> Плюс это можно будет ещё скажем для getById попробовать сделать. Там можно и эксепшен вывалить если запрошено то что видеть нельзя. А если список запрашивается, надо просто отдать видимый набор данных, а не выбрать всё из базы, а потом фильтровать

про фильтрацию я буду изучать - какие есть варианты. Я пока делаю часть без фильтрации по данным, так как данных ещё в модели нет
/This message was edited
[From: Pavel Alexeev]
 ну если без фильтрации, то вроде всё верно.

[From: Pavel Alexeev]
Мы назначили обсуждение в команде на завтра, решим как с ролями в ЕГАИС быть, и тогда расскажем как передавать вам роли.