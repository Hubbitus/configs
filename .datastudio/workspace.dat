1.0.tx=SELECT\n\tCOUNT(*)\n--\twe.*\n--\t,CASE\n--\t\tWHEN cl.id IS NOT NULL THEN 'bo_contract_lease'\n--\t\tWHEN cp.id IS NOT NULL THEN 'bo_contract_permanent'\n--\t\tWHEN cfw.id IS NOT NULL THEN 'bo_contract_forest_works'\n--\t\tWHEN cps.id IS NOT NULL THEN 'bo_contract_plants_sale'\n--\t\tWHEN cr.id IS NOT NULL THEN 'bo_contract_report'\n--\t\tWHEN cfd.id IS NOT NULL THEN 'bo_contract_forest_declaration'\n--\tEND as "contract_kind"\n--\t,COALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id, cfd.id) as contract_id\nFROM\n\tbo_woodlot_elements we\n\tLEFT JOIN bo_sub_forestry sf ON (sf.id \= we.bo_sub_forestry_fkey)\n\tLEFT JOIN bo_forestry f ON (f.id \= we.bo_forestry_fkey)\n\tLEFT JOIN bo_constituent_entity ce ON (ce.id \= we.bo_const_entity_fkey)\n\tLEFT JOIN bo_forestry sf_f ON (sf_f.id \= sf.bo_forestry_fkey)\n\t---- Contracts\:\n\t-- bo_contract_lease\:\n\tLEFT JOIN rel_contract_lease_woodlot r_cl ON (r_cl.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_lease cl ON (cl.id \= r_cl.bo_contract_lease_fkey)\n\t-- bo_contract_permanent\:\n\tLEFT JOIN rel_contract_permanent_woodlot r_cp ON (r_cp.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_permanent cp ON (cp.id \= r_cp.bo_contract_permanent_fkey)\n\t-- bo_contract_forest_works\:\n\tLEFT JOIN bo_contract_forest_works cfw ON (cfw.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_plants_sale\:\n\tLEFT JOIN bo_contract_plants_sale cps ON (cps.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_report\:\n\tLEFT JOIN rel_report_to_element r_cr ON (r_cr.bo_woodlot_elements_fkey \= we.id) -- direct elements id, not bo_woodlot_fkey\!\n\tLEFT JOIN bo_contract_report cr ON (cr.id \= r_cr.bo_contract_report_fkey)\n\t-- bo_contract_forest_declaration\:\n\tLEFT JOIN rel_declaration_to_element r_cfd ON (r_cfd.bo_woodlot_elements_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_forest_declaration cfd ON (cfd.id \= r_cfd.bo_forest_declaration_fkey)\nWHERE\n\tCOALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id, cfd.id) IS NULL\n/\n\nSELECT *\nFROM pg_available_extensions\n/\n\nCREATE EXTENSION pg_hint_plan\n/\n\nSELECT bo_contract_hardwood_fkey, COUNT(*)\nFROM bo_hardwood_deal_details detail\nGROUP BY bo_contract_hardwood_fkey\nORDER BY COUNT(*) DESC\n/\n\nEXPLAIN\nSELECT\n\tcontract.id\n\t, contract.bo_document_fkey\n\t, contract.bo_party_buyer_fkey\n\t, contract.bo_party_seller_fkey\n\t, contract.buyer_info_date\n\t, contract.seller_info_date\n\t, contract.buyer_inn\n\t, contract.seller_inn\n\t, contract.deal_number\n\t, contract.main_deal_number\n\t, contract.is_buyer\n\t, contract.wood_storages\n\t, contract.buyer_sign_date\n\t, contract.seller_sign_date\n\t, contract.deal_type\n\t, contract.wood_type\n\t, contract.seller_signature\n\t, contract.buyer_signature\n\t, contract.seller_thumb_print\n\t, contract.buyer_thumb_print\n\t, contract.seller_signed_by\n\t, contract.buyer_signed_by\n\t, doc.registration_fail_reason\n\t, s1.hardwood_volume AS wood_volume\n\t, doc.contract_num\n\t, doc.contract_start_date\n\t, doc.contract_end_date\n\t, doc.doc_type_fkey\n\t, doc.lu_land_type_fkey\n\t, doc.status\n\t, doc.create_date\n\t, doc.update_date\n\t, doc.sign_date\n\t, doc.signal_status\n\t, src_sys.id AS source_system_id\n\t, src_sys.label AS source_system_label\n--\t,buyer.inn as buyer_inn\n--\t,seller.inn as seller_inn\nFROM\n\tbo_contract_hardwood_deal contract\n\t\tLEFT JOIN (\n\t\t\tSELECT detail.bo_contract_hardwood_fkey\n\t\t\t\t, SUM(hardwood_volume) hardwood_volume\n\t\t\tFROM\n\t\t\t\tbo_hardwood_deal_details detail\n\t\t\tGROUP BY\n\t\t\t\tdetail.bo_contract_hardwood_fkey\n\t\t) s1 ON (s1.bo_contract_hardwood_fkey \= contract.id)\n\t\tINNER JOIN bo_document_base doc ON (doc.id \= contract.bo_document_fkey)\n\t\tINNER JOIN bo_party seller ON seller.id \= contract.bo_party_seller_fkey\n\t\tINNER JOIN bo_party buyer ON buyer.id \= contract.bo_party_buyer_fkey\n\t\tINNER JOIN bo_system src_sys ON doc.source_system \= src_sys.id\n--WHERE\n--\t((buyer.inn \= ?) OR (seller.inn \= ?)) AND doc.create_date>\=?\nWHERE\n--\tcontract.id IN ('P_5648','P_1429','P_1430','P_1428','P_5165','P_6807','P_5712','P_5713','P_3884','P_3883')\n--\t((buyer.inn \= '3507004819') OR (seller.inn \= '3704008001')) AND doc.create_date>\= '2015-07-20'\n\t((buyer.inn \= '7702633864') OR (seller.inn \= '7702633864')) AND doc.create_date>\= '2015-07-20'\nORDER BY\n\tcontract.id\nLIMIT 20 OFFSET 0
11.0.tx=LOAD 'pg_hint_plan'\n/\n\nSET pg_hint_plan.enable_hint TO on\n/\n\nSHOW pg_hint_plan.enable_hint\n/\n\n/*+ HashJoin(party l d c) */\nEXPLAIN ANALYZE\nSELECT\n\tCOUNT(*)\n--\tL.label_num\n--\tC.id AS contract_id\n--\t, C.main_deal_number , D.contract_num , D.contract_start_date , D.contract_end_date , L.bo_party_fkey ,\n--\tCASE\n--\t\tWHEN party.party_type_fkey IN (0, 2)\n--\t\tTHEN party.party_name\n--\t\tWHEN party.party_type_fkey IN (1, 3)\n--\t\tTHEN concat(party.person_last_name, ' ', party.person_first_name,' ', party.person_mid_name)\n--\t\tELSE ''\n--\tEND AS pname, L.id AS label_id , L.label_date , L.lu_tnved_class_fkey , L.wood_volume , L.label_num , L.status , L.reason , L.reason_type_fkey , W.okp_code , W.wood_class , party.inn\nFROM\n\tbo_labels l\n\tLEFT JOIN bo_party party ON (party.id \= l.bo_party_fkey)\n\tLEFT JOIN bo_document_base d ON (d.id \= l.bo_doc_base_fkey)\n\tLEFT JOIN bo_contract_hardwood_deal c ON (c.bo_document_fkey \= d.id)\n\tLEFT JOIN lu_tnved_class w ON w.id \= l.lu_tnved_class_fkey\nWHERE\n\tparty.inn \= '2534005760'\n--ORDER BY\n--\tL.label_num ASC\n--LIMIT 20 OFFSET 40\n/\n\nSET enable_nestloop \= OFF;\n/\n\nSET enable_nestloop \= ON;\n/\n\n/*+\n\tRows(l party \#155555)\n*/\nEXPLAIN (ANALYZE)\nSELECT\n\tc.id AS contract_id\n\t,c.main_deal_number\n\t,d.contract_num\n\t,d.contract_start_date\n\t,d.contract_end_date\n\t,l.bo_party_fkey\n\t,CASE\n\t\tWHEN party.party_type_fkey IN (0, 2)\n\t\tTHEN party.party_name\n\t\tWHEN party.party_type_fkey IN (1, 3)\n\t\tTHEN concat(party.person_last_name, ' ', party.person_first_name,' ', party.person_mid_name)\n\t\tELSE ''\n\tEND AS pname\n\t,l.id AS label_id\n\t,l.label_date\n\t,l.lu_tnved_class_fkey\n\t,l.wood_volume\n\t,l.label_num\n\t,l.status\n\t,l.reason\n\t,l.reason_type_fkey\n\t,w.okp_code\n\t,w.wood_class\n\t,party.inn\nFROM\n\tbo_labels l\n\tLEFT JOIN bo_party party ON (party.id \= l.bo_party_fkey)\n\tLEFT JOIN bo_document_base d ON (d.id \= l.bo_doc_base_fkey)\n\tLEFT JOIN bo_contract_hardwood_deal c ON (c.bo_document_fkey \= d.id)\n\tLEFT JOIN lu_tnved_class w ON (w.id \= l.lu_tnved_class_fkey)\nWHERE\n--\tparty.inn \= '2534005760'\n\tparty.inn \= '123'\nORDER BY\n\tl.label_num ASC\nLIMIT 20 OFFSET 0\n/\n\nSELECT\n\twe.bo_forestry_fkey as "woodlot->forestry", sf.bo_forestry_fkey as "woodlot->sub_forestry->forestry"\n\t,we.bo_const_entity_fkey as "woodlot->const_entity", f.bo_const_entity_fkey as "woodlot->forestry->const_entity", sf_f.bo_const_entity_fkey as "woodlot->sub_forestry->forestry->const_entity"\n\t,we.update_date\n\t,CASE\n\t\tWHEN cl.id IS NOT NULL THEN 'bo_contract_lease'\n\t\tWHEN cp.id IS NOT NULL THEN 'bo_contract_permanent'\n\t\tWHEN cfw.id IS NOT NULL THEN 'bo_contract_forest_works'\n\t\tWHEN cps.id IS NOT NULL THEN 'bo_contract_plants_sale'\n\t\tWHEN cr.id IS NOT NULL THEN 'bo_contract_report'\n\t\tWHEN cfd.id IS NOT NULL THEN 'bo_contract_forest_declaration'\n\tEND as "contract_kind"\n\t,COALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id, cfd.id) as contract_id\nFROM\n\tbo_woodlot_elements we\n\tLEFT JOIN bo_sub_forestry sf ON (sf.id \= we.bo_sub_forestry_fkey)\n\tLEFT JOIN bo_forestry f ON (f.id \= we.bo_forestry_fkey)\n\tLEFT JOIN bo_constituent_entity ce ON (ce.id \= we.bo_const_entity_fkey)\n\tLEFT JOIN bo_forestry sf_f ON (sf_f.id \= sf.bo_forestry_fkey)\n\t---- Contracts\:\n\t-- bo_contract_lease\:\n\tLEFT JOIN rel_contract_lease_woodlot r_cl ON (r_cl.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_lease cl ON (cl.id \= r_cl.bo_contract_lease_fkey)\n\t-- bo_contract_permanent\:\n\tLEFT JOIN rel_contract_permanent_woodlot r_cp ON (r_cp.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_permanent cp ON (cp.id \= r_cp.bo_contract_permanent_fkey)\n\t-- bo_contract_forest_works\:\n\tLEFT JOIN bo_contract_forest_works cfw ON (cfw.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_plants_sale\:\n\tLEFT JOIN bo_contract_plants_sale cps ON (cps.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_report\:\n\tLEFT JOIN rel_report_to_element r_cr ON (r_cr.bo_woodlot_elements_fkey \= we.id) -- Direct elements id, not bo_woodlot_fkey\!\n\tLEFT JOIN bo_contract_report cr ON (cr.id \= r_cr.bo_contract_report_fkey)\n\t-- bo_contract_forest_declaration\:\n\tLEFT JOIN rel_declaration_to_element r_cfd ON (r_cfd.bo_forest_declaration_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_forest_declaration cfd ON (cfd.id \= r_cfd.bo_forest_declaration_fkey)\nWHERE\n\t(\n\t\tsf.id IS NOT NULL AND we.bo_forestry_fkey IS NOT NULL\n\t\tAND\n\t\twe.bo_forestry_fkey \!\= sf.bo_forestry_fkey\n\t)\n\tOR (\n\t\tf.id IS NOT NULL AND we.bo_const_entity_fkey IS NOT NULL\n\t\tAND\n\t\twe.bo_const_entity_fkey \!\= f.bo_const_entity_fkey )\n\tOR (\n\t\tsf.id IS NOT NULL AND we.bo_const_entity_fkey IS NOT NULL\n\t\tAND\n\t\twe.bo_const_entity_fkey \!\= sf_f.bo_const_entity_fkey\n\t)\n/\n\nSELECT\n\tCASE\n\t\tWHEN cl.id IS NOT NULL THEN 'bo_contract_lease'\n\t\tWHEN cp.id IS NOT NULL THEN 'bo_contract_permanent'\n\t\tWHEN cfw.id IS NOT NULL THEN 'bo_contract_forest_works'\n\t\tWHEN cps.id IS NOT NULL THEN 'bo_contract_plants_sale'\n\t\tWHEN cr.id IS NOT NULL THEN 'bo_contract_report'\n\t\tWHEN cfd.id IS NOT NULL THEN 'bo_contract_forest_declaration'\n\tEND as "contract_kind"\n\t,COALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id, cfd.id) as contract_id\n\t,COUNT(*)\nFROM\n\tbo_woodlot_elements we\n\tLEFT JOIN bo_sub_forestry sf ON (sf.id \= we.bo_sub_forestry_fkey)\n\tLEFT JOIN bo_forestry f ON (f.id \= we.bo_forestry_fkey)\n\tLEFT JOIN bo_constituent_entity ce ON (ce.id \= we.bo_const_entity_fkey)\n\tLEFT JOIN bo_forestry sf_f ON (sf_f.id \= sf.bo_forestry_fkey)\n\t---- Contracts\:\n\t-- bo_contract_lease\:\n\tLEFT JOIN rel_contract_lease_woodlot r_cl ON (r_cl.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_lease cl ON (cl.id \= r_cl.bo_contract_lease_fkey)\n\t-- bo_contract_permanent\:\n\tLEFT JOIN rel_contract_permanent_woodlot r_cp ON (r_cp.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_permanent cp ON (cp.id \= r_cp.bo_contract_permanent_fkey)\n\t-- bo_contract_forest_works\:\n\tLEFT JOIN bo_contract_forest_works cfw ON (cfw.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_plants_sale\:\n\tLEFT JOIN bo_contract_plants_sale cps ON (cps.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_report\:\n\tLEFT JOIN rel_report_to_element r_cr ON (r_cr.bo_woodlot_elements_fkey \= we.id) -- direct elements id, not bo_woodlot_fkey\!\n\tLEFT JOIN bo_contract_report cr ON (cr.id \= r_cr.bo_contract_report_fkey)\n\t-- bo_contract_forest_declaration\:\n\tLEFT JOIN rel_declaration_to_element r_cfd ON (r_cfd.bo_woodlot_elements_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_forest_declaration cfd ON (cfd.id \= r_cfd.bo_forest_declaration_fkey)\nGROUP BY\n\t1, 2\nLIMIT 100\n/\n\nSELECT\n\tCOUNT(*)\n--\twe.*\n--\t,CASE\n--\t\tWHEN cl.id IS NOT NULL THEN 'bo_contract_lease'\n--\t\tWHEN cp.id IS NOT NULL THEN 'bo_contract_permanent'\n--\t\tWHEN cfw.id IS NOT NULL THEN 'bo_contract_forest_works'\n--\t\tWHEN cps.id IS NOT NULL THEN 'bo_contract_plants_sale'\n--\t\tWHEN cr.id IS NOT NULL THEN 'bo_contract_report'\n--\t\tWHEN cfd.id IS NOT NULL THEN 'bo_contract_forest_declaration'\n--\tEND as "contract_kind"\n--\t,COALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id, cfd.id) as contract_id\nFROM\n\tbo_woodlot_elements we\n--\tLEFT JOIN bo_sub_forestry sf ON (sf.id \= we.bo_sub_forestry_fkey)\n--\tLEFT JOIN bo_forestry f ON (f.id \= we.bo_forestry_fkey)\n--\tLEFT JOIN bo_constituent_entity ce ON (ce.id \= we.bo_const_entity_fkey)\n--\tLEFT JOIN bo_forestry sf_f ON (sf_f.id \= sf.bo_forestry_fkey)\n\t---- Contracts\:\n\t-- bo_contract_lease\:\n\tLEFT JOIN rel_contract_lease_woodlot r_cl ON (r_cl.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_lease cl ON (cl.id \= r_cl.bo_contract_lease_fkey)\n\t-- bo_contract_permanent\:\n\tLEFT JOIN rel_contract_permanent_woodlot r_cp ON (r_cp.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_permanent cp ON (cp.id \= r_cp.bo_contract_permanent_fkey)\n\t-- bo_contract_forest_works\:\n\tLEFT JOIN bo_contract_forest_works cfw ON (cfw.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_plants_sale\:\n\tLEFT JOIN bo_contract_plants_sale cps ON (cps.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_report\:\n\tLEFT JOIN rel_report_to_element r_cr ON (r_cr.bo_woodlot_elements_fkey \= we.id) -- direct elements id, not bo_woodlot_fkey\!\n\tLEFT JOIN bo_contract_report cr ON (cr.id \= r_cr.bo_contract_report_fkey)\n\t-- bo_contract_forest_declaration\:\n\tLEFT JOIN rel_declaration_to_element r_cfd ON (r_cfd.bo_woodlot_elements_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_forest_declaration cfd ON (cfd.id \= r_cfd.bo_forest_declaration_fkey)\nWHERE\n--\tCOALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id, cfd.id) IS NULL\n\tr_cl.id IS NULL AND r_cp.id IS NULL AND cfw.id IS NULL AND cps.id IS NULL AND r_cr.id IS NULL AND r_cfd.id IS NULL\n/\n\n-- Woodlot elements count by declaration\nSELECT\n\tCOUNT(*), contract.id, contract.bo_document_fkey, b.contract_num, p.inn\nFROM\n\tbo_contract_forest_declaration contract\n\tJOIN bo_woodlot_elements element ON (element.bo_woodlot_fkey \= contract.bo_woodlot_fkey)\n\tJOIN bo_document_base b ON (b.id \= contract.bo_document_fkey)\n\tJOIN bo_party p ON (p.id \= contract.bo_party_fkey)\nGROUP BY\n\tcontract.id, b.contract_num, contract.bo_document_fkey, p.inn\nORDER BY\n\tCOUNT(*) DESC, contract.id, b.contract_num, p.inn\n/\n\nUPDATE bo_woodlot_elements we\nSET surface_area_value \= 0.77\nFROM\n\tbo_contract_forest_declaration c\nWHERE\n\t(we.bo_woodlot_fkey \= c.bo_woodlot_fkey) -- ON\n\tAND c.id \= 'P_20858'\n\tAND 0 \= surface_area_value\n/\n\n\nSELECT\n\tcontract.id\n\t, contract.bo_document_fkey\n\t, contract.bo_party_buyer_fkey\n\t, contract.bo_party_seller_fkey\n\t, contract.buyer_info_date\n\t, contract.seller_info_date\n\t, contract.buyer_inn\n\t, contract.seller_inn\n\t, contract.deal_number\n\t, contract.main_deal_number\n\t, contract.is_buyer\n\t, contract.wood_storages\n\t, contract.buyer_sign_date\n\t, contract.seller_sign_date\n\t, contract.deal_type\n\t, contract.wood_type\n\t, contract.seller_signature\n\t, contract.buyer_signature\n\t, contract.seller_thumb_print\n\t, contract.buyer_thumb_print\n\t, contract.seller_signed_by\n\t, contract.buyer_signed_by\n\t, doc.registration_fail_reason\n--\t, s1.hardwood_volume AS wood_volume\n\t, doc.contract_num\n\t, doc.contract_start_date\n\t, doc.contract_end_date\n\t, doc.doc_type_fkey\n\t, doc.lu_land_type_fkey\n\t, doc.status\n\t, doc.create_date\n\t, doc.update_date\n\t, doc.sign_date\n\t, doc.signal_status\n\t, src_sys.id AS source_system_id\n\t, src_sys.label AS source_system_label\n--\t,buyer.inn as buyer_inn\n--\t,seller.inn as seller_inn\nFROM\n\tbo_contract_hardwood_deal contract\n\t\tINNER JOIN bo_document_base doc ON (doc.id \= contract.bo_document_fkey)\n\t\tINNER JOIN bo_party seller ON seller.id \= contract.bo_party_seller_fkey\n\t\tINNER JOIN bo_party buyer ON buyer.id \= contract.bo_party_buyer_fkey\n\t\tINNER JOIN bo_system src_sys ON doc.source_system \= src_sys.id\n\t\tJOIN (\n\t\t\tSELECT detail.bo_contract_hardwood_fkey\n\t\t\t\t, SUM(hardwood_volume) hardwood_volume\n\t\t\tFROM\n\t\t\t\tbo_hardwood_deal_details detail\n\t\t\tGROUP BY\n\t\t\t\tdetail.bo_contract_hardwood_fkey\n\t\t) s1 ON (s1.bo_contract_hardwood_fkey \= contract.id)\n--WHERE\n--\t((buyer.inn \= ?) OR (seller.inn \= ?)) AND doc.create_date>\=?\nWHERE\n--\tcontract.id IN ('P_5648','P_1429','P_1430','P_1428','P_5165','P_6807','P_5712','P_5713','P_3884','P_3883')\n\t((buyer.inn \= '7702633864') OR (seller.inn \= '7702633864'))\n AND doc.create_date>\= '2015-07-01'\n--\t(buyer.inn \= '7702633864')\n--\t(\n--\t\t(buyer.inn \= '7702633864')\n----\t\tOR (seller.inn \= '7702633864')\n--\t)\n--\tAND\n--\tdoc.create_date>\= '2015-07-20'\nORDER BY\n\tcontract.id\nLIMIT 20 OFFSET 0\n/\n\nEXPLAIN ANALYZE\nSELECT\n\tcontract.id\n\t, contract.bo_document_fkey\n\t, contract.bo_party_buyer_fkey\n\t, contract.bo_party_seller_fkey\n\t, contract.buyer_info_date\n\t, contract.seller_info_date\n\t, contract.buyer_inn\n\t, contract.seller_inn\n\t, contract.deal_number\n\t, contract.main_deal_number\n\t, contract.is_buyer\n\t, contract.wood_storages\n\t, contract.buyer_sign_date\n\t, contract.seller_sign_date\n\t, contract.deal_type\n\t, contract.wood_type\n\t, contract.seller_signature\n\t, contract.buyer_signature\n\t, contract.seller_thumb_print\n\t, contract.buyer_thumb_print\n\t, contract.seller_signed_by\n\t, contract.buyer_signed_by\n\t, doc.registration_fail_reason\n\t, s1.hardwood_volume AS wood_volume\n\t, doc.contract_num\n\t, doc.contract_start_date\n\t, doc.contract_end_date\n\t, doc.doc_type_fkey\n\t, doc.lu_land_type_fkey\n\t, doc.status\n\t, doc.create_date\n\t, doc.update_date\n\t, doc.sign_date\n\t, doc.signal_status\n\t, src_sys.id AS source_system_id\n\t, src_sys.label AS source_system_label\n--\t,buyer.inn as buyer_inn\n--\t,seller.inn as seller_inn\nFROM\n\tbo_contract_hardwood_deal contract\n\t\tLEFT JOIN (\n\t\t\tSELECT detail.bo_contract_hardwood_fkey\n\t\t\t\t, SUM(hardwood_volume) hardwood_volume\n\t\t\tFROM\n\t\t\t\tbo_hardwood_deal_details detail\n\t\t\tGROUP BY\n\t\t\t\tdetail.bo_contract_hardwood_fkey\n\t\t) s1 ON (s1.bo_contract_hardwood_fkey \= contract.id)\n\t\tINNER JOIN bo_document_base doc ON (doc.id \= contract.bo_document_fkey)\n\t\tINNER JOIN bo_party seller ON seller.id \= contract.bo_party_seller_fkey\n\t\tINNER JOIN bo_party buyer ON buyer.id \= contract.bo_party_buyer_fkey\n\t\tINNER JOIN bo_system src_sys ON doc.source_system \= src_sys.id\n--WHERE\n--\t((buyer.inn \= ?) OR (seller.inn \= ?)) AND doc.create_date>\=?\nWHERE\n--\tcontract.id IN ('P_5648','P_1429','P_1430','P_1428','P_5165','P_6807','P_5712','P_5713','P_3884','P_3883')\n\t((buyer.inn \= '7702633864') OR (seller.inn \= '7702633864')) AND doc.create_date>\= '2015-07-01'\nORDER BY\n\tcontract.id\nLIMIT 20 OFFSET 0\n/\n\nANALYZE VERBOSE bo_contract_hardwood_deal\n/\n\nREINDEX TABLE bo_contract_hardwood_deal\n/\n\nREINDEX TABLE bo_party\n/\n\nANALYZE VERBOSE bo_party
12.0.tx=SET enable_seqscan \= ON;\n\n/\n\n/* +\nIndexScan(seller bo_party_inn_idx)\nIndexScan(buyer bo_party_inn_idx)\n*/\nEXPLAIN ANALYZE\nSELECT\n\tcontract.id\nFROM\n\tbo_contract_hardwood_deal contract\n--\tINNER JOIN bo_party seller ON seller.id \= contract.bo_party_seller_fkey\n--\tINNER JOIN bo_party buyer ON buyer.id \= contract.bo_party_buyer_fkey\n\tLEFT JOIN bo_party seller ON (seller.id \= contract.bo_party_seller_fkey AND seller.inn IN ('543205580269', '5049019393') )\n\tLEFT JOIN bo_party buyer ON (buyer.id \= contract.bo_party_buyer_fkey AND buyer.inn IN ('543205580269', '5049019393') )\nWHERE 1\=1\n--\tcontract.id IN ('P_5648','P_1429','P_1430','P_1428','P_5165','P_6807','P_5712','P_5713','P_3884','P_3883')\n--\t((buyer.inn \= '7702633864') OR (seller.inn \= '7702633864')) AND doc.create_date>\= '2015-07-01'\n--\tAND buyer.inn \= '543205580269'\n--\tAND seller.inn \= '543205580269'\n--\tAND buyer.inn \= '543205580269' AND seller.inn \= '543205580269'\n--\tAND (buyer.inn \= '543205580269' OR seller.inn \= '543205580269')\n--\tAND (seller.inn \= '543205580269' OR buyer.inn \= '543205580269')\n\tAND (seller.id IS NOT NULL OR buyer.id IS NOT NULL) AND (buyer.inn \= '543205580269' OR seller.inn \= '543205580269')\n/\n\nDROP INDEX tmp__bo_contract_hardwood_deal_seller_buyer\n/\n\nCREATE INDEX tmp__bo_contract_hardwood_deal_seller_buyer ON bo_contract_hardwood_deal(bo_party_seller_fkey, bo_party_buyer_fkey)\n\n/\n\n\nEXPLAIN ANALYZE\nWITH c AS (\nSELECT\n\tcontract.*, buyer.inn as buyer_inn_, seller.inn as seller_inn_\nFROM\n\tbo_contract_hardwood_deal contract\n--\t\tLEFT JOIN (\n--\t\t\tSELECT detail.bo_contract_hardwood_fkey\n--\t\t\t\t, SUM(hardwood_volume) hardwood_volume\n--\t\t\tFROM\n--\t\t\t\tbo_hardwood_deal_details detail\n--\t\t\tGROUP BY\n--\t\t\t\tdetail.bo_contract_hardwood_fkey\n--\t\t) s1 ON (s1.bo_contract_hardwood_fkey \= contract.id)\n--\t\tINNER JOIN bo_document_base doc ON (doc.id \= contract.bo_document_fkey)\n\t\tINNER JOIN bo_party seller ON seller.id \= contract.bo_party_seller_fkey\n\t\tINNER JOIN bo_party buyer ON buyer.id \= contract.bo_party_buyer_fkey\n)\nSELECT *\nFROM c\nWHERE\n\tbuyer_inn_ \= '543205580269' OR seller_inn_ \= '543205580269'\nLIMIT 20\n\n/\nSELECT\n\tcontract.id, contract.bo_party_seller_fkey, contract.bo_party_buyer_fkey, seller.inn, buyer.inn\nFROM\n\tbo_contract_hardwood_deal contract\n\tINNER JOIN bo_party seller ON seller.id \= contract.bo_party_seller_fkey\n\tINNER JOIN bo_party buyer ON buyer.id \= contract.bo_party_buyer_fkey\nWHERE 1\=1\n\tAND RANDOM() < 0.1\n--\tAND (buyer.inn \= '7702633864' OR seller.inn \= '7702633864')\nLIMIT 20\n/\n\nSELECT RANDOM()\n/\n\n-- http\://stackoverflow.com/questions/3318727/postgresql-index-usage-analysis\nSELECT relname, seq_scan-idx_scan AS too_much_seq, case when seq_scan-idx_scan>0 THEN 'Missing Index?' ELSE 'OK' END, pg_relation_size(relname\:\:regclass) AS rel_size, seq_scan, idx_scan\n FROM pg_stat_all_tables\n WHERE schemaname\='public' AND pg_relation_size(relname\:\:regclass)>80000 ORDER BY too_much_seq DESC;\n/\n
4.0.tx=SELECT * FROM s_right_s_resource\n/\n\nSELECT *\nFROM meta_model\n/\n\n/\nSELECT *\nFROM bo_federal_district\n/\n\nUPDATE\n\tbo_federal_district\nSET\n\tupdate_date \= null\n\t,updated_by \= 'migrate'\n\t,initial_id \= null\n\t,deleted \= false\n\n/\nDELETE FROM bo_federal_district\nWHERE name LIKE 'CLONE%'\n\n/\ndelete from s_right_s_resource where s_resource_id in (1,2,3,4);\n/\n\nSELECT *\nFROM bo_system\n/\n\nSELECT datname, COUNT(*)\nFROM pg_stat_activity\nGROUP by datname\n/\n\nSELECT *\nFROM pg_stat_activity\n/\n\nSELECT datname, COUNT(*)\nFROM pg_stat_activity\nGROUP by datname\n/\n\nSELECT *\nFROM bo_forestry\nWHERE id \= 'G_00227'\n/\n\nSELECT *\nFROM bo_federal_district\n/\n\nSELECT *\nFROM bo_forestry\nWHERE name LIKE '%\u0423\u0441\u0442\u044C%'\n/\n\nSELECT *\nFROM user_logins\n/\n\nWITH seller AS (\n\t\tSELECT p.id, inn\n\t\tFROM\n\t\t\tbo_party p\n\t\tWHERE\n--\t\t\tp.id IN ('G_2000_286', 'G_111113762') -- DEBUG\n\t\t\tparty_type_fkey \!\= 3 -- '\u0424\u0438\u0437\u0438\u0447\u0435\u0441\u043A\u043E\u0435 \u043B\u0438\u0446\u043E'\n\t\t\tAND random() < 0.1\n\t\tLIMIT 10\n    ),\n\tbuyer AS (\n\t\tSELECT p.id, inn\n\t\tFROM\n\t\t\tbo_party p\n\t\tWHERE\n\t\t\trandom() < 0.1\n--\t\t\tp.id IN('P_1161', 'P_108638') -- DEBUG\n\t\tLIMIT 10\n\t),\n\tdeal_numbers_count AS (\n\t\tSELECT\n\t\t\tCOUNT(c.id) + 1 as next_deal_number, seller.id as seller_id, buyer.id as buyer_id, seller.inn as seller_inn, buyer.inn as buyer_inn\n\t\tFROM\n\t\t\tseller\n\t\t\tJOIN buyer ON (buyer.id \!\= seller.id) -- random, but not the same\n\t\t\tLEFT JOIN bo_contract_hardwood_deal c ON (bo_party_seller_fkey \= seller.id AND bo_party_buyer_fkey \= buyer.id)\n\t\tGROUP BY\n\t\t\tseller.id, buyer.id, seller.inn, buyer.inn\n\t)\n    ,created_docbase AS(\n\t\tINSERT INTO bo_document_base (id, doc_type_fkey, contract_num, create_date, source_system, source_key, created_by, lu_land_type_fkey, status)\n\t\tSELECT 'TEST_' || nextval('sq_bo_document_base'), 7, 'test_' || CEIL(RANDOM() * 1000), NOW(), 'P', dnc.seller_id || '+' || dnc.buyer_id, 'test_gen', 1, 1\n\t\tFROM deal_numbers_count dnc\n\t\tRETURNING id, source_key -- Unfortunately dnc.seller_id, dnc.buyer_id can't be returned, so do hack place it into source_key\n\t)\n\t,created_hardwood_deal AS(\n\t\tINSERT INTO bo_contract_hardwood_deal (id, bo_document_fkey, bo_party_seller_fkey, bo_party_buyer_fkey, seller_inn, buyer_inn, deal_number, main_deal_number, deal_type, wood_type)\n\t\tSELECT 'TEST_' || nextval('sq_bo_contract_hardwood_deal'), d.id, dnc.seller_id, dnc.buyer_id, dnc.seller_inn, dnc.buyer_inn, dnc.next_deal_number, (lpad((dnc.next_deal_number)\:\:text, 4, '0') || lpad(buyer_inn, 12, '0') || lpad(seller_inn, 12, '0') /*ContractHardwoodUtils\#createMainDealNumber CV_1 variant*/), 1, 0\n\t\tFROM\n\t\t\tdeal_numbers_count dnc\n\t\t\tJOIN created_docbase d ON (d.source_key \= (dnc.seller_id || '+' || dnc.buyer_id) )\n\t\tRETURNING id, bo_document_fkey\n\t)\n\t,documents AS(\n\t\tSELECT\n\t\t\tdnc.*\n\t\t--\t,'d>' as "d>"\n\t\t\t,d.id as docbase_id\n\t\t\t,d.source_key as docbase_source_key\n\t\t--\t,'c>' as "c>"\n\t\t\t,c.id as hardwood_deal_id\n\t\tFROM\n\t\t\tdeal_numbers_count dnc\n\t\t\tJOIN created_docbase d ON (d.source_key \= (dnc.seller_id || '+' || dnc.buyer_id) )\n\t\t\tJOIN created_hardwood_deal c ON (d.id \= c.bo_document_fkey)\n\t)\n\t,created_labels AS (\n\t\tINSERT INTO bo_labels (id, label_date, lu_tnved_class_fkey, wood_volume, label_num, bo_doc_base_fkey, create_date, source_system, created_by, bo_party_fkey, status)\n\t\tSELECT 'TEST_' || nextval('sq_bo_labels'), NOW(), (SELECT id FROM lu_tnved_class WHERE RANDOM() < 0.1 LIMIT 1), ROUND(RANDOM()\:\:numeric * 10, 2), 'gen\:' || ds.docbase_source_key || '\:' || gen.i, ds.docbase_id, NOW(), 'P', 'test_gen', ds.seller_id, 1\n\t\tFROM\n\t\t\tdocuments ds\n\t\t\tCROSS JOIN generate_series(1, RANDOM(100, 500)\:\:int) WITH ORDINALITY as gen(gen, i)\n\t\tRETURNING *\n\t)\nSELECT\n--\tl.*\n--\t,'ds>' as "ds>"\n--\t,ds.*\n\tCOUNT(*)\nFROM\n\tcreated_labels l\n\tJOIN documents ds ON (ds.docbase_id \= l.bo_doc_base_fkey)\n/\n\nSELECT\n *\n--\tCOUNT(*)\nFROM bo_document_signal\n/\n\nSELECT\n--\t COUNT(*)\n\t*\nFROM bo_document_base\nWHERE signal_status IS NULL\n/\n\nSELECT *\nFROM bo_document_base base\nWHERE signal_status IS NULL AND EXISTS (\n\tSELECT bo_document_fkey\n\tFROM bo_document_signal s\n\tWHERE s.bo_document_fkey \= base.id\n)\n/\n\n--SELECT *\n--DELETE\nFROM bo_document_signal s\nWHERE EXISTS (\n\tSELECT *\n\tFROM bo_document_base b\n\tWHERE b.id \= s.bo_document_fkey AND b.signal_status IS NULL\n)\n/\n\n\nSELECT\n/*\n\tdoc.id AS document_id\n\t, doc.contract_num\n\t, doc.contract_start_date\n\t, doc.contract_end_date\n\t, doc.doc_type_fkey\n\t, source_system.id AS source_system_id\n\t, source_system.label AS source_system_label\n\t, doc.updated_by_system\n\t, doc.create_date\n\t, doc.update_date\n\t, doc.created_by\n\t, doc.updated_by\n\t, doc.source_key\n\t, doc.status\n\t, doc.contract_term_in_months\n\t, doc.lu_land_type_fkey\n\t, doc.registration_fail_reason\n\t, const_entity.id AS const_entity_id\n\t, const_entity.name AS const_entity_name\n\t, state_authority.id AS state_authority_id\n\t, state_authority.name AS state_authority_name\n\t, state_authority.address AS state_authority_address\n\t, federal_district.id AS federal_district_id\n\t, federal_district.name AS federal_district_name\n\t, federal_district.short_name AS federal_district_short_name\n\t, federal_district.short_name_eng AS federal_district_short_name_eng\n\t, contract.id AS contract_id\n\t, contract.coniferous_volume\n\t, contract.hardwood_volume\n\t, contract.softwood_volume\n\t, contract.unclassified_volume\n\t, contract.receipt_date\n\t, party.ogrn\n\t, party.inn\n\t, party.id AS party_id\n\t, party.party_type_fkey\n\t, party.party_name\n\t, party.person_last_name\n\t, party.person_first_name\n\t, party.person_mid_name\n\t, party.person_doc_type_fkey\n\t, party.person_doc_series\n\t, party.person_doc_num\n\t, party.physical_address\n\t, party.country_code_fkey\n\t, \n\tCASE \n\t\tWHEN party.party_type_fkey IN (0, 2) \n\t\t\tTHEN party.party_name \n\t\tWHEN party.party_type_fkey IN (1, 3) \n\t\t\tTHEN concat(party.person_last_name, ' ', party.person_first_name,' ', party.person_mid_name)\n\t\tELSE '' \n\tEND AS pname\n\t, doc.signal_status signal_weight\n\t, \n\tCASE \n\t\tWHEN doc.signal_status \= 1 \n\t\tTHEN 1\n\t\tELSE 0\n\tEND AS unresolved_signal_count\n\t,\n\tCASE \n\t\tWHEN doc.signal_status IN (2,3) \n\t\tTHEN 1\n\t\tELSE 0\n\tEND AS resolved_signal_count\n\t, \n\tCASE \n\t\tWHEN doc.signal_status \= 2\n\t\tTHEN 1\n\t\tELSE 0\n\tEND AS processed_violation\n\t, contract.own_needs\n\t, contract.bo_contract_forest_works_fkey \n*/\n\tparty.id\n\t,doc.contract_num\n\t,CASE \n\t\tWHEN party.party_type_fkey IN (0, 2) \n\t\t\tTHEN party.party_name \n\t\tWHEN party.party_type_fkey IN (1, 3) \n\t\t\tTHEN concat(party.person_last_name, ' ', party.person_first_name,' ', party.person_mid_name)\n\t\tELSE '' \n\tEND AS pname\n\t,party.party_type_fkey\n\t,pt.type\n\t,party.party_name\n\t,party.person_last_name\n\t,party.person_first_name\n\t,party.person_mid_name\nFROM\n\tbo_party party\n\t, bo_state_authority state_authority\n\t, bo_constituent_entity const_entity\n\t, bo_federal_district federal_district\n\t, bo_system source_system\n\t, bo_document_base doc\n\t, bo_contract_plants_sale contract\n\t,lu_party_type pt\nWHERE\n\tdoc.id \= contract.bo_document_fkey \n\tAND party.id \= contract.bo_party_fkey \n\tAND state_authority.id \= contract.bo_state_authority_fkey \n\tAND const_entity.id \= state_authority.bo_constituent_entity_fkey \n\tAND federal_district.id \= const_entity.bo_federal_district_fkey \n\tAND source_system.id \= doc.source_system \n\n\tAND (pt.id \= party.party_type_fkey)\n\n--\tAND party.id IN ('G_23385850', 'G_154377810', 'P_220825', 'P_190935', 'G_11988265', 'G_27171001', 'P_217942', 'P_110614')\n--\tAND party_type_fkey NOT IN (0, 1, 3)\n\tAND pt.type IN ('\u042E\u0440\u0438\u0434\u0438\u0447\u0435\u0441\u043A\u043E\u0435 \u043B\u0438\u0446\u043E', '\u0418\u043D\u043E\u0441\u0442\u0440\u0430\u043D\u043D\u0430\u044F \u043A\u043E\u043C\u043F\u0430\u043D\u0438\u044F') AND (\n\t\tparty.person_last_name IS NOT NULL \n\t\tOR party.person_first_name IS NOT NULL \n\t\tOR party.person_mid_name IS NOT NULL\n\t)\nORDER BY\n\tpname DESC\nLIMIT 200 OFFSET 0\n/\n\nSELECT *\nFROM bo_state_authority\nWHERE name ILIKE '%\u041A\u041E\u0421\u0422\u0415\u0420\u0415\u0412\u0421\u041A\u041E\u0415 \u0412\u041E\u0415\u041D\u041D\u041E\u0415 \u041B\u0415\u0421\u041D\u0418\u0427\u0415\u0421\u0422\u0412\u041E%'\n/\n\nSELECT *\nFROM bo_constituent_entity\nWHERE id \= 33\n/\n\nSELECT *\nFROM bo_state_authority\n-- WHERE name LIKE '%\u0424\u0413\u0423%155%'\n/\n\nSELECT *\nFROM bo_contract_report\n/\n\nSELECT *\nFROM bo_woodlot_elements\n/\n\nSELECT *\nFROM lu_wood_breed\n/\n\nSELECT\n\twoodlot.id AS woodlot_id\n--\t,element.bo_forestry_fkey AS forestry_id\n\t,forestry.name AS forestry_name\n--\t,element.id AS element_id\n--\t,element.bo_const_entity_fkey AS const_entity_id\n\t,const_entity.name AS const_entity_name\n--\t,element.bo_sub_forestry_fkey AS sub_forestry_id\n\t,sub_forestry.name AS sub_forestry_name\n--\t,element.bo_tract_fkey AS tract_id\n\t,tract.name AS tract_name\n\t,element.forest_block_num\n\t,element.survey_plot_range\n--\t,element.surface_area_value\n\t,element.exact_element_num\n\t,rel.exact_element_num\n\t,wb.breed_desc\n\t,wc.wood_class\nFROM\n\tbo_contract_report contract\n\tJOIN bo_woodlot woodlot ON (contract.bo_woodlot_fkey\=woodlot.id )\n\tINNER JOIN bo_woodlot_elements element ON (element.bo_woodlot_fkey \= woodlot.id)\n\tLEFT JOIN bo_constituent_entity const_entity ON (element.bo_const_entity_fkey \= const_entity.id)\n\tLEFT JOIN bo_forestry forestry ON (element.bo_forestry_fkey \= forestry.id)\n\tLEFT JOIN bo_sub_forestry sub_forestry ON (element.bo_sub_forestry_fkey \= sub_forestry.id)\n\tLEFT JOIN bo_tract tract ON (element.bo_tract_fkey \= tract.id)\n\tJOIN rel_report_to_element rel ON (rel.bo_contract_report_fkey \= contract.id AND rel.bo_woodlot_elements_fkey \= element.id)\n\tLEFT JOIN lu_wood_breed wb ON (wb.id \= rel.wood_breed_fkey)\n\tLEFT JOIN lu_wood_class wc ON (wc.id \= rel.wood_class_fkey)\nWHERE\n\tcontract.id\= 'G_100033548'\nORDER BY\n\telement.exact_element_num, rel.exact_element_num\n/\n\nSELECT *\nFROM rel_report_to_element\n/\n\nSELECT *\nFROM bo_contract_report contract \nINNER JOIN bo_document_base doc ON contract.bo_document_fkey \= doc.id \nWHERE contract.reporting_year \= 2016 \nAND contract.reporting_month \= 1\nAND contract.bo_document_underlying_fkey \= 'P_147712'\nAND contract.bo_party_fkey \= 'G_100697804'\nAND doc.status \= 2\n/\n\nSELECT\n\t(\tSELECT\n\t\t\t\tCOUNT(*)\n\t\t\tFROM\n\t\t\t\tbo_contract_report contract \n\t\t\t\tINNER JOIN bo_document_base doc ON contract.bo_document_fkey \= doc.id \n\t\t\tWHERE\n\t\t\t\tcontract.reporting_year\:\:int \= 2008\n\t\t\t\tAND contract.reporting_month\:\:int \= 9\n\t\t\t\tAND contract.bo_document_underlying_fkey\:\:text \= 'G_15302406'\n\t\t\t\tAND contract.bo_party_fkey\:\:text \= 'G_13746151'\n\t\t\t\tAND doc.status\:\:int4 \= 2)\n/\n\nSELECT *\nFROM bo_contract_report\nWHERE id \= 'G_100008953'\n/\n\nSELECT\n--\tCOUNT(*)\n\tcontract.id, contract.reporting_year, contract.reporting_month, contract.bo_document_underlying_fkey, contract.bo_party_fkey\n\t,doc.status\n\t,doc.id\nFROM\n\tbo_contract_report contract \n\tINNER JOIN bo_document_base doc ON (contract.bo_document_fkey \= doc.id)\nWHERE\n\tcontract.id \= 'G_100008953'\n--\tcontract.reporting_year\:\:int \= 2008\n--\tAND contract.reporting_month\:\:int \= 9\n--\tAND contract.bo_document_underlying_fkey\:\:text \= 'G_15302406'\n--\tAND contract.bo_party_fkey\:\:text \= 'G_13746151'\n--\tAND doc.status\:\:int \= 2\n/\n\nSELECT status FROM bo_document_base WHERE id \= 'G_100008953'\n\n/\n\nCREATE TABLE public.bo_contract_report  ( \n\tid                         \tid_type NOT NULL,\n\tbo_document_fkey           \tid_type NULL,\n\tbo_party_fkey              \tid_type NULL,\n\tbo_woodlot_fkey            \tid_type NULL,\n\tbo_document_underlying_fkey\tid_type NULL,\n\tbo_state_authority_fkey    \tint4 NULL,\n\treporting_year             \tint2 NULL,\n\treporting_month            \tint2 NULL,\n\treceipt_date               \ttimestamp NULL,\n\tPRIMARY KEY(id)\n)\nGO\nALTER TABLE public.bo_contract_report\n\tADD CONSTRAINT bo_woodlot_fkey\n\tFOREIGN KEY(bo_woodlot_fkey)\n\tREFERENCES public.bo_woodlot(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nALTER TABLE public.bo_contract_report\n\tADD CONSTRAINT bo_party_fkey\n\tFOREIGN KEY(bo_party_fkey)\n\tREFERENCES public.bo_party(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nALTER TABLE public.bo_contract_report\n\tADD CONSTRAINT bo_document_underlying_fkey\n\tFOREIGN KEY(bo_document_underlying_fkey)\n\tREFERENCES public.bo_document_base(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nALTER TABLE public.bo_contract_report\n\tADD CONSTRAINT bo_document_fkey\n\tFOREIGN KEY(bo_document_fkey)\n\tREFERENCES public.bo_document_base(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nCOMMENT ON TABLE public.bo_contract_report IS '\u041E\u0442\u0447\u0435\u0442 \u043B\u0435\u0441\u043E\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\:\=>'\nGO\nCOMMENT ON COLUMN public.bo_contract_report.id IS '\u0418\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440\:\=>\u0418\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440 (\u043E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 \u043A\u043B\u044E\u0447)'\nGO\nCOMMENT ON COLUMN public.bo_contract_report.bo_document_fkey IS '\u0411\u0430\u0437\u043E\u0432\u044B\u0439 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\:\=>\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0431\u0430\u0437\u043E\u0432\u0443\u044E \u0447\u0430\u0441\u0442\u044C \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430'\nGO\nCOMMENT ON COLUMN public.bo_contract_report.bo_party_fkey IS '\u041B\u0435\u0441\u043E\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C\:\=>'\nGO\nCOMMENT ON COLUMN public.bo_contract_report.bo_woodlot_fkey IS '\u041B\u0435\u0441\u043D\u043E\u0439 \u0443\u0447\u0430\u0441\u0442\u043E\u043A\:\=>'\nGO\nCOMMENT ON COLUMN public.bo_contract_report.bo_document_underlying_fkey IS '\u041F\u0440\u0430\u0432\u043E\u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u044E\u0449\u0438\u0439 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\:\=>\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0431\u0430\u0437\u043E\u0432\u0443\u044E \u0447\u0430\u0441\u0442\u044C \u043F\u0440\u0430\u0432\u043E\u0443\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u044E\u0449\u0435\u0433\u043E \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430 \u0434\u043B\u044F \u043A\u043E\u0442\u043E\u0440\u043E\u0433\u043E \u043F\u043E\u0434\u0430\u043D\u0430 \u0434\u0435\u043A\u043B\u0430\u0440\u0430\u0446\u0438\u044F'\nGO\n/\n\n\nCREATE TABLE public.bo_document_base  ( \n\tid                      \tid_type NOT NULL,\n\tdoc_type_fkey           \tint2 NULL,\n\tcontract_num            \ttext NULL,\n\tcontract_start_date     \tdate NULL,\n\tcreate_date             \ttimestamp NULL,\n\tupdate_date             \ttimestamp NULL,\n\tsource_system           \ttext NULL,\n\tsource_key              \ttext NULL,\n\tcreated_by              \ttext NULL,\n\tupdated_by              \ttext NULL,\n\tcontract_end_date       \tdate NULL,\n\tcontract_term_in_months \tint2 NULL,\n\tlu_land_type_fkey       \tint2 NULL,\n\tupdated_by_system       \ttext NULL,\n\tstatus                  \tint4 NULL,\n\treason                  \ttext NULL,\n\treason_type_fkey        \tint4 NULL,\n\tregistration_fail_reason\ttext NULL,\n\tsignal_status           \tint4 NULL,\n\tsigned_by               \ttext NULL,\n\tsignature               \ttext NULL,\n\tthumb_print             \ttext NULL,\n\tPRIMARY KEY(id)\n)\nGO\nALTER TABLE public.bo_document_base\n\tADD CONSTRAINT reason_type_fkey\n\tFOREIGN KEY(reason_type_fkey)\n\tREFERENCES public.lu_reason_type(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nALTER TABLE public.bo_document_base\n\tADD CONSTRAINT lu_doc_type_fkey\n\tFOREIGN KEY(doc_type_fkey)\n\tREFERENCES public.lu_doc_type(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nALTER TABLE public.bo_document_base\n\tADD CONSTRAINT fk_land_type\n\tFOREIGN KEY(lu_land_type_fkey)\n\tREFERENCES public.lu_land_type(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nALTER TABLE public.bo_document_base\n\tADD CONSTRAINT bo_document_base_source_system_fkey\n\tFOREIGN KEY(source_system)\n\tREFERENCES public.bo_system(id)\n\tMATCH FULL\n\tON DELETE NO ACTION \n\tON UPDATE NO ACTION \nGO\nCOMMENT ON TABLE public.bo_document_base IS '\u0411\u0430\u0437\u043E\u0432\u0430\u044F \u0447\u0430\u0441\u0442\u044C \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u043E\u0432\:\=>\u041E\u0441\u043D\u043E\u0432\u043D\u0430\u044F \u0447\u0430\u0441\u0442\u044C \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430'\nGO\nCOMMENT ON COLUMN public.bo_document_base.id IS '\u0418\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440\:\=>\u0418\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0442\u043E\u0440 (\u043E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 \u043A\u043B\u044E\u0447)'\nGO\nCOMMENT ON COLUMN public.bo_document_base.doc_type_fkey IS '\u0422\u0438\u043F \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430\:\=>'\nGO\nCOMMENT ON COLUMN public.bo_document_base.contract_num IS '\u041D\u043E\u043C\u0435\u0440 \u0434\u043E\u0433\u043E\u0432\u043E\u0440\u0430\:\=>'\nGO\nCOMMENT ON COLUMN public.bo_document_base.contract_start_date IS '\u0414\u0430\u0442\u0430 \u0437\u0430\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F\:\=>\u0414\u0430\u0442\u0430 \u0437\u0430\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F (\u044E\u0440\u0438\u0434\u0438\u0447\u0435\u0441\u043A\u0430\u044F)'\nGO\nCOMMENT ON COLUMN public.bo_document_base.create_date IS '\u0414\u0430\u0442\u0430 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F\:\=>\u0414\u0430\u0442\u0430 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F (\u0434\u0430\u0442\u0430 \u0432\u0432\u043E\u0434\u0430 \u0434\u0430\u043D\u043D\u044B\u0445 \u0432 \u0415\u0413\u0410\u0418\u0421)'\nGO\nCOMMENT ON COLUMN public.bo_document_base.update_date IS '\u0414\u0430\u0442\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F\:\=>'\nGO\nCOMMENT ON COLUMN public.bo_document_base.source_system IS '\u0421\u0438\u0441\u0442\u0435\u043C\u0430 \u0438\u0441\u0442\u043E\u0447\u043D\u0438\u043A\:\=>'\nGO\nCOMMENT ON COLUMN public.bo_document_base.source_key IS '\u041A\u043B\u044E\u0447 \u0432 \u0438\u0441\u0442\u043E\u0447\u043D\u0438\u043A\u0435\:\=>\u041A\u043B\u044E\u0447 \u0437\u0430\u043F\u0438\u0441\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0435 \u0438\u0441\u0442\u043E\u0447\u043D\u0438\u043A\u0435, \u0437\u0430\u043F\u043E\u043B\u043D\u044F\u0435\u0442\u0441\u044F \u043A\u043E\u0433\u0434\u0430 \u043F\u0440\u043E\u0438\u0441\u0445\u043E\u0434\u0438\u0442 \u0438\u043C\u043F\u043E\u0440\u0442 \u0434\u0430\u043D\u043D\u044B\u0445 \u0432 \u0415\u0413\u0410\u0418\u0421 \u0438\u0437 \u0434\u0440\u0443\u0433\u043E\u0439 \u0441\u0438\u0441\u0442\u0435\u043C\u044B'\nGO\nCOMMENT ON COLUMN public.bo_document_base.created_by IS '\u0421\u043E\u0437\u0434\u0430\u0442\u0435\u043B\u044C\:\=>\u041B\u043E\u0433\u0438\u043D \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u0441\u043E\u0437\u0434\u0430\u0432\u0448\u0435\u0433\u043E \u0437\u0430\u043F\u0438\u0441\u044C'\nGO\nCOMMENT ON COLUMN public.bo_document_base.updated_by IS '\u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0438\u0437\u043C\u0435\u043D\u0438\u0432\u0448\u0438\u0439\:\=>\u041B\u043E\u0433\u0438\u043D \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F \u043E\u0431\u043D\u043E\u0432\u0438\u0432\u0448\u0435\u0433\u043E \u0437\u0430\u043F\u0438\u0441\u044C'\nGO\nCOMMENT ON COLUMN public.bo_document_base.contract_end_date IS '\u0414\u0430\u0442\u0430 \u043E\u043A\u043E\u043D\u0447\u0430\u043D\u0438\u044F\:\=>\u0414\u0430\u0442\u0430 \u043E\u043A\u043E\u043D\u0447\u0430\u043D\u0438\u044F (\u044E\u0440\u0438\u0434\u0438\u0447\u0435\u0441\u043A\u0430\u044F)'\nGO\nCOMMENT ON COLUMN public.bo_document_base.contract_term_in_months IS '\u0421\u0440\u043E\u043A \u043C\u0435\u0441.\:\=>\u0421\u0440\u043E\u043A (\u043A\u043E\u043B-\u0432\u043E \u043C\u0435\u0441\u044F\u0446\u0435\u0432)'\nGO\nCOMMENT ON COLUMN public.bo_document_base.lu_land_type_fkey IS '\u0422\u0438\u043F \u0437\u0435\u043C\u043B\u0438\:\=>'\nGO\n\n/\n\nSELECT\n--\tCOUNT(cl.id) as cl_id_count, \n--\tCOUNT(*) as "*_count"\n--\t, COALESCE(cl('G_108256388_145-2009-12_U0056_\u041C\u0438\u0447\u0443\u0440\u0438\u043D\u0430_18_17','P_1431356','P_1543388','P_1315225','P_1315268','P_7794337','P_7794338').id, cp.id, cfw.id, cps.id, cr.id, cfd.id) as coalesce_count\n\t*\nFROM\n\tbo_woodlot_elements we\n\t---- Contracts\:\n\t-- bo_contract_lease\:\n\tLEFT JOIN rel_contract_lease_woodlot r_cl ON (r_cl.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_lease cl ON (cl.id \= r_cl.bo_contract_lease_fkey) -- count\: 1867397\n\t-- bo_contract_permanent\:\n\tLEFT JOIN rel_contract_permanent_woodlot r_cp ON (r_cp.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_permanent cp ON (cp.id \= r_cp.bo_contract_permanent_fkey)\n\t-- bo_contract_forest_works\:\n\tLEFT JOIN bo_contract_forest_works cfw ON (cfw.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_plants_sale\:\n\tLEFT JOIN bo_contract_plants_sale cps ON (cps.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\t-- bo_contract_report\:\n\tLEFT JOIN rel_report_to_element r_cr ON (r_cr.bo_woodlot_elements_fkey \= we.id) -- direct elements id, not bo_woodlot_fkey\!\n\tLEFT JOIN bo_contract_report cr ON (cr.id \= r_cr.bo_contract_report_fkey)\n\t-- bo_contract_forest_declaration\:\n\tLEFT JOIN rel_declaration_to_element r_cfd ON (r_cfd.bo_forest_declaration_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_forest_declaration cfd ON (cfd.id \= r_cfd.bo_forest_declaration_fkey)\nWHERE\n--\tcl.id is NOT NULL\n\tCOALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id, cfd.id) IS NULL -- res 5095336\n--\tCOALESCE(cl.id, cp.id, cfw.id, cps.id, cr.id) IS NULL -- res 5476387\nLIMIT 20\n/\n\nSELECT\n\tCOUNT(*)\nFROM\n\tbo_woodlot_elements we\n\tLEFT JOIN rel_contract_lease_woodlot r_cl ON (r_cl.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tLEFT JOIN bo_contract_lease cl ON (cl.id \= r_cl.bo_contract_lease_fkey)\nWHERE cl.id is NOT NULL\n-- res\: 1867397\n/\n\nSELECT COUNT(*)\nFROM\n\tbo_woodlot_elements elements\n\tINNER JOIN bo_woodlot woodlot ON elements.bo_woodlot_fkey \= woodlot.id\n\tINNER JOIN rel_contract_lease_woodlot rel ON rel.bo_woodlot_fkey \= woodlot.id\n\tINNER JOIN bo_contract_lease contract ON rel.bo_contract_lease_fkey \= contract.id\n-- res\: 1867397\n/\n\nSELECT\n\t*\nFROM\n\tbo_woodlot_elements we\n\tINNER JOIN rel_contract_lease_woodlot r_cl ON (r_cl.bo_woodlot_fkey \= we.bo_woodlot_fkey)\n\tINNER JOIN bo_contract_lease cl ON (cl.id \= r_cl.bo_contract_lease_fkey)\nWHERE\n\tNOT EXISTS(\n\t\tSELECT 1\n\t\tFROM\n\t\t\tbo_woodlot_elements elements\n\t\t\tINNER JOIN bo_woodlot woodlot ON elements.bo_woodlot_fkey \= woodlot.id\n\t\t\tINNER JOIN rel_contract_lease_woodlot rel ON rel.bo_woodlot_fkey \= woodlot.id\n\t\t\tINNER JOIN bo_contract_lease contract ON rel.bo_contract_lease_fkey \= contract.id\n\t\tWHERE\n\t\t\tcontract.id \= cl.id\n\t)\n\n/\n\nSELECT *\nFROM\n\tbo_woodlot_elements we\n\tJOIN bo_woodlot w ON (w.id \= we.bo_woodlot_fkey)\nWHERE we.id IN ('G_108256388_145-2009-12_U0056_\u041C\u0438\u0447\u0443\u0440\u0438\u043D\u0430_18_17','P_1431356','P_1543388','P_1315225','P_1315268','P_7794337','P_7794338')\n/\n\nSELECT COUNT(*)\nFROM bo_woodlot_elements\n/\n\nSELECT\n\tcontract.id, b.contract_num, COUNT(*)\nFROM\n\tbo_contract_forest_declaration contract\n\tJOIN bo_woodlot_elements element ON (element.bo_woodlot_fkey \= contract.bo_woodlot_fkey)\n\tJOIN bo_document_base b ON (b.id \= contract.bo_document_fkey)\nGROUP BY\n\tcontract.id, b.contract_num\nORDER BY\n\t3 DESC, 1, 2\n/\n\nSELECT\n\t*\nFROM\n\tbo_contract_forest_declaration c\n\tJOIN bo_woodlot_elements we ON (we.bo_woodlot_fkey \= c.bo_woodlot_fkey)\nWHERE\n\tc.id \= 'P_10986'\n\tAND 0 \= surface_area_value\n/\n\n\nUPDATE bo_woodlot_elements we\nSET surface_area_value \= 0.77\nFROM\n\tbo_contract_forest_declaration c\nWHERE\n\t(we.bo_woodlot_fkey \= c.bo_woodlot_fkey) -- ON\n\tAND c.id \= 'P_10986'\n\tAND 0 \= surface_area_value\n/\n\n\n-- Woodlot elements count by declaration\nSELECT\n\tCOUNT(*), contract.id, contract.bo_document_fkey, b.contract_num, p.inn\nFROM\n\tbo_contract_forest_declaration contract\n\tJOIN bo_woodlot_elements element ON (element.bo_woodlot_fkey \= contract.bo_woodlot_fkey)\n\tJOIN bo_document_base b ON (b.id \= contract.bo_document_fkey)\n\tJOIN bo_party p ON (p.id \= contract.bo_party_fkey)\nGROUP BY\n\tcontract.id, b.contract_num, contract.bo_document_fkey, p.inn\nORDER BY\n\tCOUNT(*) DESC, contract.id, b.contract_num, p.inn\n/\n\nSELECT *\nFROM\n\tbo_contract_forest_declaration c\n\tJOIN bo_document_base b ON (b.id \= c.bo_document_fkey)\nWHERE\n\tc.id IN('P_43014','P_43015','P_43016','P_43017','P_43018','P_43019')
7.0.tx=-- WoodlotElements count by ContractForestDeclaration\nSELECT\n\tCOUNT(*), contract.id, contract.bo_document_fkey, b.contract_num, p.inn\nFROM\n\tbo_contract_forest_declaration contract -- (checked by code, no rel)\n\tJOIN bo_woodlot_elements element ON (element.bo_woodlot_fkey \= contract.bo_woodlot_fkey)\n\tJOIN bo_document_base b ON (b.id \= contract.bo_document_fkey)\n\tJOIN bo_party p ON (p.id \= contract.bo_party_fkey)\nGROUP BY\n\tcontract.id, b.contract_num, contract.bo_document_fkey, p.inn\nORDER BY\n\tCOUNT(*) DESC, contract.id, b.contract_num, p.inn\n/
8.0.tx=/**\n* Function to calculate checksum and check INN correct for physical person.\n* Algorithm from\: https\://ru.wikipedia.org/wiki/%D0%98%D0%B4%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B9_%D0%BD%D0%BE%D0%BC%D0%B5%D1%80_%D0%BD%D0%B0%D0%BB%D0%BE%D0%B3%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%89%D0%B8%D0%BA%D0%B0\#.D0.92.D1.8B.D1.87.D0.B8.D1.81.D0.BB.D0.B5.D0.BD.D0.B8.D0.B5_.D0.BA.D0.BE.D0.BD.D1.82.D1.80.D0.BE.D0.BB.D1.8C.D0.BD.D1.8B.D1.85_.D1.86.D0.B8.D1.84.D1.80\n*\n* @param on input take INN text representation\n* @return true if INN checksum correct, null on null input and false otherwise\n**/\nCREATE OR REPLACE FUNCTION is_inn_checksum_correct_phy(text) RETURNS boolean\n    AS $$\n\t\tWITH inn_a AS(\n\t\t\tSELECT $1 as s, regexp_split_to_array($1, '')\:\:int[] as a\n\t\t)\n\t\t,inn_chk AS(\n\t\t\tSELECT *\n\t\t\t\t, ((7 * a[1] + 2 * a[2] + 4 * a[3] + 10 * a[4] + 3 * a[5] + 5 * a[6] + 9 * a[7] + 4 * a[8] + 6 * a[9] + 8 * a[10]) % 11) % 10 as phy_11_chk\n\t\t\t\t, ((3 * a[1] + 7 * a[2] + 2 * a[3] + 4 * a[4] + 10 * a[5] + 3 * a[6] + 5 * a[7] + 9 * a[8] + 4 * a[9] + 6 * a[10] + 8 * a[11]) % 11) % 10 as phy_12_chk\n\t\t\tFROM inn_a\n\t\t)\n\t\tSELECT COALESCE(a[11] \= phy_11_chk AND a[12] \= phy_12_chk, false) as checksum_pass\n\t\tFROM inn_chk\n\t$$\n    LANGUAGE SQL\n    IMMUTABLE\n    RETURNS NULL ON NULL INPUT;\n/\n\n
